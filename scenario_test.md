# シナリオテスト仕様書

本仕様書は、AWS S3バケットからCSVファイルをダウンロードし、データ検証・加工を行い、再度S3へアップロードする一連のバッチ処理について、シナリオテスト観点で記載する。証跡はログおよびアップロードファイルを対象とし、S3にCSVファイルが存在しない場合など、業務で発生しうる全てのケースを網羅する。

## 1. シナリオ一覧

| シナリオID | シナリオ概要 |
|------------|------------------------------------------------------|
| S1         | 正常系：S3にCSVファイルが存在し、全処理が正常終了する |
| S2         | 異常系：S3にCSVファイルが存在しない場合              |
| S3         | 異常系：CSVファイルに不正値（型不一致等）が含まれる場合 |
| S4         | 異常系：columns.txtに定義されていないカラムが存在する場合 |
| S5         | 異常系：S3アップロード時にエラーが発生する場合         |
| S6         | 異常系：ZIP圧縮時にエラーが発生する場合               |

## 2. シナリオ詳細

### S1. 正常系：S3にCSVファイルが存在し、全処理が正常終了する
- 前提条件：S3バケットに指定日付・プレフィックスのCSVファイルが存在する
- 操作：バッチ処理を実行
- 期待結果：
  - ログに全処理の正常終了が記録される
  - ダウンロード、検証、加工、ZIP圧縮、S3アップロードが全て成功
  - アップロード先S3にZIPファイルが存在

### S2. 異常系：S3にCSVファイルが存在しない場合
- 前提条件：S3バケットに指定日付・プレフィックスのCSVファイルが1件も存在しない
- 操作：バッチ処理を実行
- 期待結果：
  - ログに「対象CSVファイルなし」等の警告が記録される
  - 以降の処理（検証・加工・アップロード）はスキップ
  - アップロード先S3にファイルは作成されない

### S3. 異常系：CSVファイルに不正値（型不一致等）が含まれる場合
- 前提条件：S3バケットのCSVファイルに型不一致や不正値が含まれる
- 操作：バッチ処理を実行
- 期待結果：
  - ログに不正値検出のワーニングが記録される（例：Invalid datetime in {col} at row {i}: {v}）
  - 不正値・空文字・NULLは空文字に置換される
  - 加工後のファイルがアップロードされる

### S4. 異常系：columns.txtに定義されていないカラムが存在する場合
- 前提条件：CSVファイルにcolumns.txtに定義されていないカラムが含まれる
- 操作：バッチ処理を実行
- 期待結果：
  - ログに不要カラム削除の記録（またはワーニング）が出力される
  - 不要カラムは削除される
  - 加工後のファイルがアップロードされる

### S5. 異常系：S3アップロード時にエラーが発生する場合
- 前提条件：S3アップロード時にネットワーク障害等でエラーが発生
- 操作：バッチ処理を実行
- 期待結果：
  - ログにアップロード失敗のエラーが記録される
  - アップロードがリトライされる場合はその記録も残る
  - 最終的にアップロードできなければエラー終了

### S6. 異常系：ZIP圧縮時にエラーが発生する場合
- 前提条件：ZIP圧縮処理でファイルアクセス権限等のエラーが発生
- 操作：バッチ処理を実行
- 期待結果：
  - ログにZIP圧縮失敗のエラーが記録される
  - 以降のアップロード処理はスキップ
  - エラー終了

## 3. 証跡取得方法
- ログファイル：全処理の開始・終了・エラー・ワーニング等を記録
- アップロードファイル：S3にアップロードされたZIPファイル、加工済みCSVファイル

## 4. 備考
- columns.txtの定義ミスや.envの設定ミス等、環境依存の異常系は別途テストケースで管理する
